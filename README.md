# Этап 1. Подготовка и проектирование
1) Сначала вам необходимо выбрать предметную область, в рамках которой вы будете осуществлять все дальнейшие работы в течение курса. Это может быть компания, организация, интернет-проект или любая другая сфера деятельности. 

2) Для этой предметной области сформулируйте описание функциональных требований. Они полностью должны описывать поведение вашей системы.  

3) На основе составленных описаний вы выделяете сущности, их атрибуты с указанием типов и связи между ними. Составьте ER диаграмму , которая должна полностью отображать информацию о сущностях. (описание атрибутов должно содержать в себе информацию о типе данных, первичных и внешних ключах)  

4) Последним этапом является нормализация схемы базы данных, что включает в себя проведение анализа составленной ранее схемы БД для определения функциональных зависимостей. Рассмотрите каждую таблицу и выявите функциональные зависимости между ее атрибутами.  

**Минимальные требования:**

* Рекомендованное количество отношений: 20+ (Принимающий оставляет за собой право добавить ФТ для увеличения кол-ва отношений)  
* Нормальная форма: 3НФ  

# Этап 2. Развертывание  

1) Вам необходимо развернуть СУБД PostgreSQL на сервере или локальной машине внутри docker контейнера. Для этого нужно написать docker compose файл. 

2) Напишите sql скрипты с идемпотентными миграциями для создания отношений, составленных на предыдущем этапе.  

* Таблицы должны полностью соответствовать структуре, отображенной на схеме, с учетом всех полей данных, ограничений и связей с другими таблицами. 

* Позаботьтесь о том, чтобы при создании нового контейнера ваши миграции выполнялись автоматически. 

* При развертывании миграции должны выполнятся до версии миграции, указанной в переменной окружения `MIGRATION_VERSION`. (Если env не указан, то до последней)  

* Для вашей БД в кластере СУБД должен быть создан пользователь с правами на создания БД. И уже от его имени должна создаваться БД и выполнятся миграции.  

* Для этого можете использовать инструменты миграций Flyway/liquibase, либо часто один из сервисов работающий с БД отвечает за выполнение миграций, но так как бека у нас нет, то будет сайдкар выполняющий миграции.  

3) Напишите скрипты сидирования базы данных. Это позволит вам проверить корректность структуры таблиц и их соответствие функциональным требованиям, а также в будущем тестировать производительность запросов.

* Оно должно выполняться автоматически при развертывании контейнера, если переменная окружения `APP_ENV` равна `dev`  

* Количество картожей в таблицах должны быть нормированы от значения переменной окружения  `SEED_COUNT`  

* Сидирование должно работать для ЛЮБОЙ версии миграции.  

4) Напишите скрипт который создает групповую роль `analytic` и дайте ей возможность читать, но не изменять данные в отношениях. создайте n-ое кол-во пользователей, и унаследуйте роль от `analytic`. Список имен пользователей лежит в переменной окружения `ANALYST_NAMES` через запятую. Пароль в формате `имяпользователя_123`  

# Этап 3. Администрирование, оптимизация и мониторинг  

1) На свой выбор установить инструменты мониторинга. Экспортировать полезные данные в Prometheus. Установить Grafana. Наладить экспорт метрик Grafana из Prometheus. Построить dashboard в графана по выбранным вами метрикам. Сохранить JSON dashboard из grafana.  

2) Вам нужно написать сервис имитирующий работу с сервисом. В качестве запросов выберете запросы, которые мог бы запрашивать теоретический бекенд вашей предметной области.  

3) Полученные результаты сохраните и отрисуйте как диаграмму в графане.  

4) Далее добавьте индексы к вашим отношениям и запустите сервис снова. Повторите процедуру несколько раз и попытайтесь добиться оптимальной производительности для каждого запроса.  

5) Создайте крон задачу, который будет создавать бэкапы базы данных, каждые n-времени, последние m-бекапов должны храниться, более старые должны удаляться. (параметры передаются через env: `BACKUP_RETENTION_COUNT` и `BACKUP_INTERVAL_CRON`)

6) Для отказоустойчивости вашего кластера СУБД разверните 2 реплики Postgres. С использованием Patroni. Проверьте что при отказе мастера происходит автоматическое переключение.  

# Этап 4. Тестирование миграций  

Реализуйте механизм тестирования идемпотентности ваших миграций:  

1) Каждая миграция должна иметь два скрипта:  
    * up — применяет изменения (создаёт таблицы, поля, индексы, наполняет справочники и т. д.). 
    * down — полностью отменяет все изменения этой миграции. 


2) Для каждой миграции в отдельности выполнить следующие шаги: 
    * Применить скрипт up;  
    * Сохранить текущее состояние базы (схему и, при необходимости, справочные данные);  
    * Откатить скриптом down;  
    * Снова применить скрипт up;  
    * Сохранить новое состояние базы;  
    * Сравнить первые и вторые снимки: они должны совпадать — это и есть признак идемпотентности.  


3) Повторить процедуру для каждой миграции по порядку их номерования.  


4) (Доп.) Автоматизировать всю проверку (например, в CI/CD), чтобы при любых расхождениях выполнение тестов падало с ошибкой.  